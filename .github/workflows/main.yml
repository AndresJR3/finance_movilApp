name: Construir y Probar App

# Se activa cada vez que haces 'push' a la rama 'main'
on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest # El robot usará un servidor Linux

    steps:
      # 1. Trae tu código al robot
      - name: Revisar el código
        uses: actions/checkout@v4

      # 2. Configura Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18 # O la versión que estés usando

      # 3. Configura Expo y EAS (e inicia sesión con tu token secreto)
      - name: Configurar Expo y EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # 4. Instala las dependencias (dentro de la carpeta finanzas-app)
      - name: Instalar dependencias
        working-directory: ./finanzas-app
        run: npm install

      # 5. Construye la app (perfil 'preview')
      #    Nota: --non-interactive: le dice a EAS que no haga preguntas
      #    Nota: --wait: espera a que el build termine
      #    Nota: --json: imprime el resultado como JSON para el siguiente paso
      - name: Construir app de Android para preview
        working-directory: ./finanzas-app
        run: |
          eas build --platform android --profile preview --non-interactive --wait --json > build-output.json
        env:
          # Pasa los secretos de Supabase al build
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

      # 6. Ejecutar pruebas en TestRigor
      # ... pasos anteriores (checkout, node, eas build) ...

      - name: Lanzar y esperar pruebas de TestRigor
        run: |
          # Instalamos jq por si acaso (aunque el script bash trata de ser agnóstico)
          sudo apt-get install -y jq
          
          # Dar permisos de ejecución al script
          chmod +x ./finanzas-app/scripts/run-testrigor.sh

          # Extraemos la URL
          BUILD_URL=$(jq -r '.[0].artifacts.buildUrl' finanzas-app/build-output.json)
          
          echo "Build generado en: $BUILD_URL"
          
          # Ejecutamos el script que creamos
          # Pasamos: URL, Token y Suite ID
          ./finanzas-app/scripts/run-testrigor.sh "$BUILD_URL" "${{ secrets.TESTRIGOR_API_KEY }}" "zBEpNR9X9tgaF4swH"